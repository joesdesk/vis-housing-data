---
title: "Exploratory Data Analysis of Zillow Housing Data"
author: "Jomar Sastrillo"
date: "January 21, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(rjson)
library(stringr)
library(USAboundaries)
library(sf)
```

## Exploring the housing data
We first explore the structure of the data provided.

```{r}
# The definition of every variable
data_dictionary <- read_csv("../data/DataDictionary.csv")
```

```{r}
# Every metric available
all_available_metrics <- fromJSON(file = "../data/all_available_metrics.json")
```

```{r}
# Every field for every level
fields_per_level <- fromJSON(file = "../data/fields_per_level.json")
```

```{r}
# A data frame containing whether the field is available for the given level
data_avail <- fields_per_level %>% 
    map_dfc(function(x){all_available_metrics %in% x}) %>% 
    mutate(field = all_available_metrics) %>% 
    select(field, everything())

data_avail %>% head()
```

Find the regional view which have all the fields.

```{r}
data_avail %>% 
    filter( City==T, County==T, Metro==T, Neighborhood==T, State==T, Zip==T )
```

## Extract the data

```{r}
state_homes <- read_csv(file = '../data/State_time_series.csv', col_types = cols())
zip_homes <- read_csv(file = '../data/Zip_time_series.csv', col_types = cols())
county_homes <- read_csv(file = '../data/County_time_series.csv', col_types = cols())
city_homes <- read_csv(file = '../data/City_time_series.csv.csv', col_types = cols())
```

There's a lot of variables here. First, we make sure that the correct number of states are selected.

```{r}
sel_variables <- state_homes %>% 
    filter(RegionName!='UnitedStates') %>% 
    filter(Date >= '2000-01-01') %>% 
    summarize_all( funs( sum(is.na(.)) ) ) %>% 
    gather(variable, na_count, 1:79) %>% 
    arrange(na_count) %>% 
    slice(3:14) %>% 
    pull(variable)
```

```{r}
final_homes <- state_homes %>% 
    filter(RegionName!='UnitedStates') %>% 
    filter(Date >= '2000-01-01') %>% 
    select( c('Date', 'RegionName', sel_variables) )
```

```{r}
write_csv(final_homes, path = "../results/final_homes.csv", col_names = T)
```


## Map data
We use the R package "USAboundaries" to obtain the shape of the boundaries. The documentation for this package explains that we have the available functions

```{r}
state_boundaries <- us_states(resolution = 'low')
congressional_boundaries <- us_congressional(resolution = 'low')
county_boundaries <- us_counties(resolution = 'low')
zipcode_boundaries <- us_zipcodes()
cities_boundaries <- us_cities()
```

We write functions to extract the boundaries.

```{r}
xy <- function(sfc_MULTIPOLYGON){
    
    # Extract coordinates of boundary
    sfc_MULTIPOLYGON %>%
        st_coordinates() %>%
        as.tibble() %>% 
        unite(regionid, 3:5, sep = "")
}
```

```{r}
centroid <- function(sfc_MULTIPOLYGON){
    
    # Extract centroid information
    centroid <- sfc_MULTIPOLYGON %>%
        st_centroid() %>% 
        as.tibble()
}
```



```{r}
# Test the function
state_boundaries$geometry[2] %>% xy() %>% str()
```


We use the functions to tidy the state boundary data.

```{r}
# 
tidy_state_boundaries <- state_boundaries %>% 
    as.tibble() %>%  # Allows us to remove attributes related to the geometry
    mutate(newgeometry = map(geometry, xy)) %>%   # Extract the relevant geometries
    mutate(geometry = map(geometry, identity)) %>%    # Strip attributes of raw geometry
    select(-geometry) %>%  # Remove raw geometry so it will not be affected by unnest
    unnest() %>%   # Combine the data frames of relevant geometries
    unite(shapeid, geoid, regionid, sep='') %>%
    select(statefp, state_name, X, Y, shapeid)
```


```{r}
tidy_state_boundaries %>% str()
```



```{r}
# See the final results
tidy_state_boundaries %>%
    ggplot() +
        geom_polygon(aes(x=X, y=Y, group=shapeid, fill=state_name)) + 
        xlim(-140,-50) + 
        ylim(23,50) + 
        scale_color_discrete('') + 
        guides(fill=FALSE)

#coord_fixed(ratio = 1)
```

```{r}
tidy_state_boundaries %>% str()
```

```{r}
write_csv(tidy_state_boundaries, path = '../results/state_shapes.csv', col_names = T)
```

